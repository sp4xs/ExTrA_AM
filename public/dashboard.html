<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard</title>
<style>
  body { margin: 0; font-family: Arial, sans-serif; background: #f8f9fa; }
  header {
    background: #fff; padding: 12px 16px; display: flex; justify-content: space-between;
    align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  header h1 { margin: 0; font-size: 18px; }
  header a { color: #1a73e8; text-decoration: none; font-weight: bold; font-size: 14px; }

  #upload-section {
    display: none; background: #fff; margin: 12px 16px; padding: 12px;
    border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  #upload-section h2 { margin: 0 0 10px 0; font-size: 16px; }

  #file-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px; margin: 12px 16px;
  }
  .file-card {
    background: #fff; border-radius: 10px; padding: 10px; text-align: center;
    cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: transform 0.1s ease, box-shadow 0.1s ease; font-size: 14px;
  }
  .file-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
  .file-card button { margin-top: 6px; padding: 4px 6px; font-size: 11px; cursor: pointer; }

  iframe {
    width: 100%; height: 420px; border: none; margin: 12px 16px; display: none;
    background: #fff; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  /* Watermark overlay */
  .watermark {
    position: fixed; inset: 0; pointer-events: none; z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    font-size: 36px; color: rgba(0,0,0,0.10);
    transform: rotate(-25deg); white-space: nowrap;
    background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.05) 0 1px, transparent 1px 140px);
  }

  /* Responsive tweaks */
  @media (max-width: 768px) {
    header h1 { font-size: 16px; }
    #file-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin: 10px; }
    #upload-section { margin: 10px; padding: 10px; }
    iframe { height: 320px; margin: 10px; }
  }
  @media (max-width: 480px) {
    header h1 { font-size: 15px; }
    header a { font-size: 12px; }
    #file-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin: 8px; }
    #upload-section { margin: 8px; padding: 8px; }
    iframe { height: 260px; margin: 8px; }
    .file-card { font-size: 12px; padding: 8px; }
    .file-card button { font-size: 10px; padding: 3px 5px; }
  }
</style>
</head>
<body>
<header>
  <h1>AM extra</h1>
  <a href="/logout">Logout</a>
</header>

<!-- Dev-only Upload -->
<div id="upload-section">
  <h2>Upload File</h2>
  <form id="upload-form" enctype="multipart/form-data">
    <input type="file" name="file" required />
    <button type="submit">Upload</button>
  </form>
  <p id="upload-status"></p>
</div>

<!-- File Grid -->
<div id="file-grid"></div>

<!-- Inline Viewer (no download) -->
<iframe id="file-viewer"></iframe>

<!-- Watermark -->
<div class="watermark" id="watermark">Confidential</div>

<script>
const fileGrid = document.getElementById("file-grid");
const viewer = document.getElementById("file-viewer");
const uploadSection = document.getElementById("upload-section");
const uploadForm = document.getElementById("upload-form");
const uploadStatus = document.getElementById("upload-status");
const watermark = document.getElementById("watermark");

let role = null;
let username = "";

// 1) Get current user (for watermark + role)
fetch("/me")
  .then(r => r.json())
  .then(data => {
    username = data.username || "";
    role = data.role || "user";
    watermark.textContent = `Confidential â€” ${username}`;
    if (role === "dev") uploadSection.style.display = "block";
    loadFiles();
  })
  .catch(() => window.location.href = "/login.html");

// 2) Load files and render cards
function loadFiles() {
    fetch("/files")
    .then(r => r.json())
    .then(files => {
      fileGrid.innerHTML = "";
      files.forEach(file => {
        const card = document.createElement("div");
        card.className = "file-card";
        card.textContent = file;
        fileGrid.appendChild(card);


        const nameSpan = document.createElement("div");
        nameSpan.textContent = file;
        card.appendChild(nameSpan);

        // Open inline (no direct link)
        card.onclick = () => {
          viewer.src = "/view/" + encodeURIComponent(file);
          viewer.style.display = "block";
          window.scrollTo({ top: viewer.offsetTop, behavior: "smooth" });
        };

        // Dev controls
        if (role === "dev") {
          const controls = document.createElement("div");

          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm("Delete this file?")) {
              fetch("/file/" + encodeURIComponent(file), { method: "DELETE" })
                .then(r => r.text()).then(msg => { alert(msg); loadFiles(); });
            }
          };
          controls.appendChild(delBtn);

          const renBtn = document.createElement("button");
          renBtn.textContent = "Rename";
          renBtn.style.marginLeft = "6px";
          renBtn.onclick = (e) => {
            e.stopPropagation();
            const newName = prompt("Enter new file name:", file);
            if (newName && newName.trim()) {
              fetch("/file/" + encodeURIComponent(file), {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ newName })
              }).then(r => r.text()).then(msg => { alert(msg); loadFiles(); });
            }
          };
          controls.appendChild(renBtn);

          card.appendChild(controls);
        }

        fileGrid.appendChild(card);
      });
    });
}

// 3) Handle uploads (dev)
if (uploadForm) {
  uploadForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const fd = new FormData(uploadForm);
    fetch("/upload", { method: "POST", body: fd })
      .then(r => r.text())
      .then(msg => { uploadStatus.textContent = msg; uploadForm.reset(); loadFiles(); })
      .catch(() => uploadStatus.textContent = "Upload failed");
  });
}

// 4) Make casual copying harder (cannot fully block screenshots)
document.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("keydown", e => {
  const k = e.key.toLowerCase();
  if (e.ctrlKey && ["s","u","p","c"].includes(k)) { e.preventDefault(); alert("Action disabled"); }
  if (k === "printscreen") { e.preventDefault(); alert("Screenshots are discouraged"); }
});
</script>
</body>
</html>
